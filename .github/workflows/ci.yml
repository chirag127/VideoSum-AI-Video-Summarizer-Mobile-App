# Apex CI/CD Pipeline: Validate, Test, and Build
# Standard: 2026/Q1
# Authority: Apex Technical Authority

name: 'CI: Lint, Test & Build Validation'

# ===================================================================
# TRIGGERS: This workflow runs on key repository events.
# ===================================================================
on:
  push:
    branches: ['main', 'develop']
  pull_request:
    branches: ['main']
    types: [opened, synchronize, reopened]

# ===================================================================
# CONCURRENCY CONTROL: Prevents redundant runs on the same PR.
# ===================================================================
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

# ===================================================================
# JOBS: Defines the sequence of tasks to be executed.
# ===================================================================
jobs:
  validate:
    name: 'Node.js ${{ matrix.node-version }} Validation'
    runs-on: ubuntu-latest
    permissions:
      contents: read

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      # --------------------------------------------------------------
      # STEP 1: CHECKOUT REPOSITORY
      # --------------------------------------------------------------
      - name: 'Code Checkout'
        uses: actions/checkout@v4

      # --------------------------------------------------------------
      # STEP 2: SETUP NODE.JS ENVIRONMENT
      # Caches dependencies for high-velocity execution.
      # --------------------------------------------------------------
      - name: 'Setup Node.js ${{ matrix.node-version }} Environment'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      # --------------------------------------------------------------
      # STEP 3: INSTALL DEPENDENCIES
      # Uses npm ci for deterministic, high-integrity installs.
      # --------------------------------------------------------------
      - name: 'Install Project Dependencies'
        run: npm ci

      # --------------------------------------------------------------
      # STEP 4: LINT & FORMAT CHECK (Biome)
      # Apex Standard: Enforces code quality with high-speed tooling.
      # --------------------------------------------------------------
      - name: 'Run Linter & Formatter Check'
        run: npm run lint:check

      # --------------------------------------------------------------
      # STEP 5: TYPESCRIPT TYPE CHECK
      # Ensures static type safety across the entire codebase.
      # --------------------------------------------------------------
      - name: 'Run TypeScript Type Check'
        run: npm run typecheck

      # --------------------------------------------------------------
      # STEP 6: UNIT & INTEGRATION TESTING (Vitest)
      # Apex Standard: Validates application logic with coverage reporting.
      # --------------------------------------------------------------
      - name: 'Execute Tests & Generate Coverage Report'
        run: npm run test:coverage

      # --------------------------------------------------------------
      # STEP 7: UPLOAD COVERAGE REPORT
      # Pushes coverage metrics to Codecov for analysis and badging.
      # --------------------------------------------------------------
      - name: 'Upload Coverage Report to Codecov'
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: true

      # --------------------------------------------------------------
      # STEP 8: EAS BUILD VALIDATION (MAIN BRANCH ONLY)
      # Triggers an Expo Application Services (EAS) build to validate
      # the project's native configuration and buildability post-merge.
      # --------------------------------------------------------------
      - name: 'Trigger EAS Build Validation'
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
        run: |
          echo "Triggering EAS build validation for all platforms..."
          eas build --platform all --profile production --non-interactive --no-wait
